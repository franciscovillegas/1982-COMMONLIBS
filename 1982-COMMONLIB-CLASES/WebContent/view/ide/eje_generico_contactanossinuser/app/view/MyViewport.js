/*
 * File: app/view/MyViewport.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 5.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 5.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.view.MyViewport', {
    extend: 'Ext.container.Viewport',
    alias: 'widget.myviewport',

    requires: [
        'MyApp.view.MyViewportViewModel',
        'Ext.form.Panel',
        'Ext.form.field.File',
        'Ext.form.field.TextArea',
        'Ext.toolbar.Toolbar',
        'Ext.button.Button'
    ],

    viewModel: {
        type: 'myviewport'
    },
    layout: 'fit',
    defaultListenerScope: true,

    items: [
        {
            xtype: 'form',
            loadInit: function() {


                Ext.getCmp("telefono").setValue("");
                Ext.getCmp("celular").setValue("");
                Ext.getCmp("file").setValue("");
                Ext.getCmp("motivo").setValue("");

                var f = Ext.getCmp("formulario_loadDatos");
                f.submit({
                    waitMsg: "cargando información actual...",
                    url: "../../../servlet/EjeCore?claseweb=portal.com.eje.usuario.UsuarioInfo",
                    success: function(form, action) {
                        var resp = action.result;

                        if(resp != null) {
                            Ext.getCmp("nombre").setValue(resp.nombre);
                        }
                    },
                    failure: function(form, action) {
                        var resp = action.result;
                        console.log(resp);

                        if(resp != null) {
                            Ext.getCmp("nombre").setValue(resp.nombre);
                            Ext.getCmp("cargo").setValue(resp.cargodesc);
                            Ext.getCmp("destinatario").setValue(resp.adminNombre + "<"+resp.adminMail+">");
                        }
                    }
                });



            },
            id: 'formulario',
            title: 'Formulario de contacto',
            layout: {
                type: 'vbox',
                align: 'stretch'
            },
            items: [
                {
                    xtype: 'container',
                    flex: 1,
                    margin: 20,
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    },
                    items: [
                        {
                            xtype: 'textfield',
                            id: 'nombre',
                            fieldLabel: 'Mi nombre',
                            name: 'nombre',
                            readOnly: true,
                            maxLength: 100
                        },
                        {
                            xtype: 'textfield',
                            id: 'cargo',
                            fieldLabel: 'Mi cargo',
                            name: 'cargo',
                            readOnly: true,
                            maxLength: 100
                        },
                        {
                            xtype: 'textfield',
                            id: 'telefono',
                            fieldLabel: 'Mi teléfono de contacto',
                            name: 'telefono',
                            allowBlank: false,
                            maxLength: 100
                        },
                        {
                            xtype: 'textfield',
                            id: 'celular',
                            fieldLabel: 'Mi celular de contacto',
                            name: 'celular',
                            allowBlank: false,
                            maxLength: 100
                        },
                        {
                            xtype: 'filefield',
                            hidden: true,
                            id: 'file',
                            fieldLabel: 'Adjuntar archivo',
                            name: 'file'
                        },
                        {
                            xtype: 'textareafield',
                            flex: 1,
                            id: 'motivo',
                            fieldLabel: 'Motivo de contacto',
                            name: 'motivo',
                            allowBlank: false,
                            maxLength: 3000
                        },
                        {
                            xtype: 'textfield',
                            id: 'destinatario',
                            fieldLabel: 'Destinatario',
                            name: 'destinatario',
                            readOnly: true
                        }
                    ]
                }
            ],
            dockedItems: [
                {
                    xtype: 'toolbar',
                    flex: 1,
                    dock: 'bottom',
                    layout: {
                        type: 'hbox',
                        pack: 'end'
                    },
                    items: [
                        {
                            xtype: 'button',
                            handler: function(button, e) {
                                var f = Ext.getCmp("formulario");
                                if(f.isValid()){
                                    f.submit({
                                        waitMsg: "Archivo correo para su posterior envío...",
                                        url: "../../../EjeS?modulo=eje_generico_contactanossinuser&thing=Send&accion=add",
                                        success: function(form, action) {
                                            var resp = action.result;

                                            if( resp.success == true ) {
                                                Ext.Msg.alert("contacto", resp.message, function() {
                                                    Ext.getCmp("formulario").loadInit();
                                                });
                                            }
                                            else {
                                                Ext.Msg.alert("contacto", "Error al tratar de enviar el correo.");
                                            }

                                        },
                                        failure: function(form, action) {
                                            Ext.Msg.alert("Error", "Ha ocurrido un error inesperado");
                                        }
                                    });
                                }
                                else {
                                    Ext.Msg.alert("Error", "Es necesario que complete todos los datos marcados en rojo.");
                                }


                            },
                            icon: '../../images/btns/mailing_list.ico',
                            text: 'Enviar'
                        }
                    ]
                }
            ]
        },
        {
            xtype: 'form',
            hidden: true,
            id: 'formulario_loadDatos',
            bodyPadding: 10,
            title: 'My Form'
        }
    ],
    listeners: {
        render: 'onViewportRender'
    },

    onViewportRender: function(component, eOpts) {
                console.log("render");
                Ext.getCmp("formulario").loadInit();

    }

});